var TRAK={VERSION:"0.0.1"};TRAK.Behavior=function(){this._strength=0},TRAK.Behavior.prototype={constructor:TRAK.Behavior,update:function(){},onMarker:function(){},onRegister:function(){},onRemove:function(){},getStrength:function(){return this._strength},setStrength:function(i){this._strength=i}},TRAK.BehaviorInstance=function(i,t,e,n,r,s){this._next=null,this.behavior=i,this.priority=t,this.startTime=e,this.endTime=n,this.fadeInTime=r,this.fadeOutTime=s,this.isRunning=!1},TRAK.BehaviorInstance.prototype={constructor:TRAK.BehaviorInstance,update:function(i,t){var e=t-this.startTime;this.isRunning||(this.behavior.onRegister(),this.isRunning=!0),this.fadeInTime>0&&e<this.fadeInTime?this.behavior.strength=e/this.fadeInTime:(this.timeDiff=this.endTime-this.time,this.behavior.strength=this.fadeOutTime>0&&this.timeDiff<this.fadeOutTime?e/this.fadeOutTime:1),this.behavior.update(i,t)},destroy:function(){this.behavior.onRemove()}},TRAK.CompoundBehavior=function(i){this._behaviors=i},TRAK.CompoundBehavior.prototype=new TRAK.Behavior,TRAK.CompoundBehavior.prototype.update=function(i,t){for(var e=0;e<this._behaviors.length;++e)this._behaviors[e].update(i,t)},TRAK.CompoundBehavior.prototype.onMarker=function(i){for(var t=0;t<this._behaviors.length;++t)this._behaviors[t].onMarker(i)},TRAK.CompoundBehavior.prototype.onRegister=function(){for(var i=0;i<this._behaviors.length;++i)this._behaviors[i].onRegister()},TRAK.CompoundBehavior.prototype.onRemove=function(){for(var i=0;i<this._behaviors.length;++i)this._behaviors[i].onRemove()},TRAK.CompoundBehavior.setStrength=function(i){this._strength=i;for(var t=0;t<this._behaviors.length;++t)this._behaviors[t].setStrength(i)},TRAK.FPSCounter=function(i){this._numFrames=i||1,this._frames=[],this._maxFPS=void 0,this._minFPS=void 0,this._currentFPS=0,this._averageFPS=0,this._runningSum=0;for(var t=0;t<this._numFrames;++t)this._frames[t]=0;this._index=0},TRAK.FPSCounter.prototype={update:function(i){this._currentFPS=1e3/i,this._runningSum-=this._frames[this._index],this._runningSum+=this._currentFPS,this._averageFPS=this._runningSum/this._numFrames,this._frames[this._index++]=this._currentFPS,this._index==this._numFrames&&(this._index=0),(void 0===this._maxFPS||this._currentFPS>this._maxFPS)&&(this._maxFPS=this._currentFPS),(void 0===this._minFPS||this._currentFPS<this._minFPS)&&(this._minFPS=this._currentFPS)},getLastFrameFPS:function(){return Math.round(this._currentFPS)},getAverageFPS:function(){return Math.round(this._averageFPS)},getMaxFPS:function(){return Math.round(this._maxFPS)},getMinFPS:function(){return Math.round(this._minFPS)},reset:function(){this._maxFPS=void 0,this._minFPS=void 0}},function(){for(var i=0,t=["ms","moz","webkit","o"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var e=(new Date).getTime(),n=Math.max(0,16-(e-i)),r=window.setTimeout(function(){t(e+n)},n);return i=e+n,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(i){clearTimeout(i)})}(),TRAK.FrameTicker=function(){this._isRunning=!1,this._callback=void 0,this._dt=0,this._playheadTime=0},TRAK.FrameTicker.prototype={constructor:TRAK.FrameTicker,start:function(i){this._callback=i,this._playheadTime=this._getTime(),this._isRunning=!0,this._tick(),this._tick._this=this},stop:function(){this._isRunning=!1},get dt(){return this._dt},_tick:function(){if(this._isRunning){self.requestAnimationFrame(this._tick.bind(this));var i=this._getTime();this._dt=i-this._playheadTime,this._playheadTime=i,this._callback()}},_getTime:function(){return void 0===self.performance||void 0==self.performance.now?Date.now():self.performance.now()}},TRAK.TrakEngine=function(i){this._playheadTime=0,this._bpm=i,this._markerIndex=0,this._behaviors=[],this._syncMarkers=[],this._isInitialized=!1,this._runningBehaviorHead=null},TRAK.TrakEngine.prototype={constructor:TRAK.TrakEngine,update:function(i){if(this._isInitialized||this._initialize(),this._playheadTime+=i,null!=this._runningBehaviorHead){var t=null,e=this._runningBehaviorHead,n=this._markerIndex;do{if(e.endTime<=this._playheadTime)t?t._next=e._next:this._runningBehaviorHead=e._next,e.destroy();else if(e.startTime<=this._playheadTime){for(n=this._markerIndex;n<this._syncMarkers.length&&this._syncMarkers[n].time<=this._playheadTime;)e.behavior.onMarker(this._syncMarkers[n++].name);e.update(i,this._playheadTime)}e=e._next}while(null!=e);this._markerIndex=n}},scrub:function(i){this._playheadTime=i,this._isInitialized=!1},addSyncMarker:function(i,t){this._isInitialized=!1,syncMarkers.push({time16th:time16th,name:t})},addBehavior:function(i,t,e,n,r,s){var h=15e3/this._bpm,a=t*h,o=e*h;void 0===s&&(s=0),this._behaviors.push(new TRAK.BehaviorInstance(i,s,a,o,h,h)),this._isInitialized=!1},_initialize:function(){this._isInitialized=!0,this._syncMarkers.sort(function(i,t){return i.time16th-t.time16th}),this._behaviors.sort(function(i,t){return i.priority-t.priority}),this._markerIndex=0,this._runningBehaviorHead=null;for(var i=this._behaviors.length-1;i>=0;--i){var t=this._behaviors[i];t.endTime>this._playheadTime&&(t._next=this._runningBehaviorHead,this._runningBehaviorHead=t)}}};